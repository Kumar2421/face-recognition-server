services:
  ui:
    image: node:20
    container_name: face_ui
    working_dir: /app
    volumes:
      - ./ui:/app
    environment:
      - VITE_API_BASE=${VITE_API_BASE:-http://localhost:8001}
    command: bash -lc "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    depends_on:
      - face_service

  face_service:
    container_name: face_service
    restart: unless-stopped
    depends_on:
      - qdrant
    build:
      context: .
      dockerfile: Dockerfile

    volumes:
      - ./input:/data/input:ro
      - ./facefolder:/data/facefolder:ro
      - ./buffalo_l/models:/models:ro
      - ./data/thumbs:/data/thumbs
      - ./data/images:/data/images
      - ./data/events:/data/events
      - ./data/trt_cache:/data/trt_cache
      - ./config.yaml:/app/config.yaml:ro

    environment:
      # - FACE_DIR=/media/frigate/facefolder/security
      - FACE_DIR=/data/facefolder/security
      - CONFIG_PATH=/app/config.yaml
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=frigate_faces_v3
      # - QDRANT_COLLECTION=frigate_faces_v2
      # - QDRANT_COLLECTION=frigate_faces old emp db
      - BUFFALO_MODEL_ROOT=/models
      - BUFFALO_MODEL_NAME=buffalo_l
      - BUFFALO_DET_SIZE=640
      - FACE_SERVICE_DEBUG=1
      - BUFFALO_MIN_DET_SCORE=0.3
      - BUFFALO_ENABLE_FALLBACK_VARIANTS=0
      - BUFFALO_PROVIDERS=TensorrtExecutionProvider,CUDAExecutionProvider,CPUExecutionProvider
      - ORT_TENSORRT_ENGINE_CACHE_ENABLE=1
      - ORT_TENSORRT_CACHE_PATH=/data/trt_cache
      - ORT_TENSORRT_FP16_ENABLE=1
      - FACE_EMBEDDINGS_INDEX=/data/facefolder/security_embeddings/index.json
      - GPU_INFERENCE_MANAGER=1
      - GPU_QUEUE_MAX=256
      - GPU_BATCH_WINDOW_MS=0
      - CORS_ALLOW_ORIGINS=${CORS_ALLOW_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173,https://face.service.tools.thefusionapps.com}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - AUTO_ADD_EMBEDDING_ENABLE=1
      - AUTO_ADD_EMBEDDING_MIN_SIM=0.95
      - SUBJECT_MAX_EMBEDDINGS=10
      - ENROLL_DUPLICATE_CHECK_ENABLE=1
      - ENROLL_DUPLICATE_MIN_SIM=0.75
      - NO_MATCH_AUTO_ENROLL_ENABLE=1
      - NO_MATCH_AUTO_ENROLL_PREFIX=customer

    ports:
      - "8001:8000"

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  sftp_poller:
    container_name: sftp_poller
    restart: unless-stopped
    depends_on:
      - face_service
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python3.11", "sftp_poller.py"]
    environment:
      - CONFIG_PATH=/app/config.yaml
      - API_BASE_URL=http://face_service:8000
      - SFTP_BASE_PATH=/TMJ-CBE-Entry
      - SFTP_CAMERAS_ALLOWLIST=processed
      - SFTP_PROCESSED_DIRNAME=
      # - SFTP_FILENAME_INCLUDE_ANY=
      # - SFTP_FILENAME_EXCLUDE_ANY=
      - SFTP_FILENAME_INCLUDE_ANY=FACE_SNAP
      - SFTP_FILENAME_EXCLUDE_ANY=FACE_BACKGROUND
      - SFTP_MAX_FILES_PER_CAMERA_PER_TICK=500
      - SFTP_TIMEZONE=Asia/Kolkata
      # - SFTP_SINCE_DATETIME=07-02-2026:09 pm
      # - SFTP_UNTIL_DATETIME=07-02-2026:10 pm
    volumes:
      - ./config.yaml:/app/config.yaml:ro

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage

volumes:
  qdrant_storage: